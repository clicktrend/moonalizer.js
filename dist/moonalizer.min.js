/*! moonalizer 02-09-2014 */
function Calculator(a,b){this.date=moment.utc(a).hour(12).toDate(),this.criterion=b,this.calculate=function(a,b){return this.criterion.calculate(this.date,a,b)}}function Yallop(a){this.init(a)}function Plotter(a,b,c){this.counter=0,this.operations=b.length,this.codes={},this.resetCodes=function(){this.codes={A:{},B:{},C:{},D:{},E:{},F:{}}},this.resetCodes(),this.calculateAsync=function(){this.resetCodes(),this.asyncStartTimer=new Date,this.counter=0,window.setTimeout(this.doAsyncWork(),0)},this.doAsyncWork=function(){if(this.counter>=this.operations)return this.asyncStopTimer=new Date-this.asyncStartTimer,void c.jobDone(this);c.jobRunning(this);for(var d=0;10>d&&!(this.counter>=this.operations);d++){if(b[this.counter]){var e=b[this.counter],f=a.calculate(e.lat,e.lon);"undefined"!=typeof b[this.counter-1]&&e.lat!==b[this.counter-1].lat&&c.jobLatitudeDone(this),"G"!==f.code&&"undefined"!=typeof this.codes[f.code]&&("undefined"==typeof this.codes[f.code][e.lat]&&(this.codes[f.code][e.lat]=[]),this.codes[f.code][e.lat].push(e.lon))}this.counter++}window.setTimeout(this.doAsyncWork.bind(this),0)}}var Algorithm=function(){this.init()};Algorithm.prototype.init=function(a){"undefined"!=typeof a&&(this.model=a)},Algorithm.prototype.getSunset=function(){},Algorithm.prototype.getMoonset=function(){},Algorithm.prototype.getSunPosition=function(){},Algorithm.prototype.getMoonPosition=function(){},Algorithm.prototype.getBestTime=function(){};var SunCalcWrap=function(){this.init(SunCalc)};SunCalcWrap.prototype=new Algorithm,SunCalcWrap.prototype.constructor=SunCalcWrap,SunCalcWrap.prototype.getSunset=function(a,b,c){var d=this.model.getTimes(a,b,c);return d.sunset},SunCalcWrap.prototype.getMoonset=function(a,b,c){var d=this.model.getMoonTimes(a,b,c);return d.set},SunCalcWrap.prototype.getSunPosition=function(a,b,c){return this.model.getPosition(a,b,c)},SunCalcWrap.prototype.getMoonPosition=function(a,b,c){return this.model.getMoonPosition(a,b,c)},SunCalcWrap.prototype.getBestTime=function(a,b,c){a=moment.utc(a);var d=moment.utc(a).add("days",1),e=this.getSunset(a.toDate(),b,c),f=this.getMoonset(a.toDate(),b,c),g=this.getMoonset(d.toDate(),b,c);angular.isDefined(f)||(f=g),moment.utc(e).isSame(moment.utc(f),"days")||(f=g);var h=moment.utc(f).diff(moment.utc(e),"minutes",!0);return-1100>h&&(f=g,h=moment.utc(f).diff(moment.utc(e),"minutes",!0)),{date:moment.utc(e).add("minutes",4/9*h).toDate(),sunset:e,moonset:f,lag:h}};var Criterion=function(a){this.init(a)};Criterion.prototype.init=function(a){this.algorithm=a},Criterion.prototype.setAlgorithm=function(a){this.algorithm=a},Criterion.prototype.getCode=function(){},Criterion.prototype.calculate=function(){console.log("implement criterion")},Criterion.prototype.calculateAtBestTime=function(a,b,c){return this.date=moment.utc(this.algorithm.getBestTime(a,b,c)),this.calculate(b,c)},Criterion.prototype.calculateAtSunset=function(a,b,c){return this.date=moment.utc(this.algorithm.getSunset(a,b,c)),this.calculate(b,c)},Criterion.prototype.calculateAtSunBelowFiveDegree=function(){console.log("implement criterion")};var Diyanet=function(a){this.init(a)};Diyanet.prototype=new Criterion,Diyanet.prototype.constructor=Diyanet,Diyanet.prototype.getCode=function(a){var b="F";return a.ARCL>8&&a.ALT>5&&(b="A"),b},Diyanet.prototype.calculate=function(a,b,c){var d=this.algorithm.getBestTime(a,b,c);a=d.date;var e=this.algorithm.getSunPosition(a,b,c),f=this.algorithm.getMoonPosition(a,b,c),g=180+rad2deg(e.azimuth),h=rad2deg(e.altitude),i=180+rad2deg(f.azimuth),j=rad2deg(f.altitude),k=Math.abs(g-i),l=Math.abs(j-h),m=0;return m=l>22?Math.acos(Math.cos(k)*Math.cos(l)):Math.sqrt(k*k+l*l),{date:a,sunset:d.sunset,moonset:d.moonset,LAG:d.LAG,code:this.getCode({ARCL:m,ALT:j}),ARCL:m,ALT:j}},Yallop.prototype=new Criterion,Yallop.prototype.constructor=Yallop,Yallop.prototype.calculate=function(a,b,c){var d=this.algorithm.getBestTime(a,b,c);a=d.date;var e=this.algorithm.getSunPosition(a,b,c),f=180+rad2deg(e.azimuth),g=rad2deg(e.altitude),h=this.algorithm.getMoonPosition(a,b,c),i=180+rad2deg(h.azimuth),j=rad2deg(h.altitude),k=Math.abs(f-i),l=Math.abs(j-g),m=0;m=l>22?Math.acos(Math.cos(k)*Math.cos(l)):Math.sqrt(k*k+l*l);var n=.5*(1-Math.cos(m)),o=11950*n/h.distance,p=(l-(11.8371-6.3226*o+.7319*o*o-.1018*o*o*o))/10,q=this.getCode(p),r={date:a,code:q,sunset:d.sunset,moonset:d.moonset};return r},Yallop.prototype.getCode=function(a){return a>.216?"A":.216>=a&&a>-.014?"B":-.014>=a&&a>-.16?"C":-.16>=a&&a>-.232?"D":-.232>=a&&a>-.293?"E":-.293>=a?"F":"G"};var CalculatorFactory={create:function(a,b){return new Calculator(a,CriterionFactory.create(b))}},createDiyanet=function(a){return new Diyanet(a instanceof Algorithm?new a:new SunCalcWrap)},createYallop=function(a){return new Yallop(a instanceof Algorithm?new a:new SunCalcWrap)},CriterionFactory={create:function(a,b){return"diyanet"===a?createDiyanet(b):createYallop("yallop"===a?b:b)}},rad2deg=function(a){return 180*a/Math.PI},deg2rad=function(a){return a*Math.PI/180};