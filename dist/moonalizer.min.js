/*! moonalizer 20-09-2014 */
function Calculator(a){this.criterion=a,this.calculate=function(a,b,c){return this.criterion.calculate(moment.utc(a).hour(12).toDate(),b,c)},this.getCriterion=function(){return this.criterion},this.getAlgorithm=function(){return this.criterion.getAlgorithm()}}function Yallop(a){this.init(a)}function Plotter(a,b,c,d){this.counter=0,this.operations=c.length,this.codes={},this.resetCodes=function(){this.codes={A:{},B:{},C:{},D:{},E:{},F:{}}},this.resetCodes(),this.calculateAsync=function(){this.resetCodes(),this.asyncStartTimer=new Date,this.counter=0,window.setTimeout(this.doAsyncWork(),0)},this.doAsyncWork=function(){if(this.counter>=this.operations)return this.asyncStopTimer=new Date-this.asyncStartTimer,void d.jobDone(this);d.jobRunning(this);for(var e=0;10>e&&!(this.counter>=this.operations);e++){if(c[this.counter]){var f=c[this.counter],g=a.calculate(b,f.lat,f.lon);"undefined"!=typeof c[this.counter-1]&&f.lat!==c[this.counter-1].lat&&d.jobLatitudeDone(this),"G"!==g.code&&"undefined"!=typeof this.codes[g.code]&&("undefined"==typeof this.codes[g.code][f.lat]&&(this.codes[g.code][f.lat]=[]),this.codes[g.code][f.lat].push(f.lon))}this.counter++}window.setTimeout(this.doAsyncWork.bind(this),0)}}var Algorithm=function(){this.init()};Algorithm.prototype.init=function(a){"undefined"!=typeof a&&(this.model=a)},Algorithm.prototype.getSunset=function(){},Algorithm.prototype.getMoonset=function(){},Algorithm.prototype.getSunPosition=function(){},Algorithm.prototype.getMoonPosition=function(){},Algorithm.prototype.getBestTime=function(){};var SunCalcWrap=function(){this.init(SunCalc)};SunCalcWrap.prototype=new Algorithm,SunCalcWrap.prototype.constructor=SunCalcWrap,SunCalcWrap.prototype.getSunset=function(a,b,c){var d=this.model.getTimes(a,b,c);return d.sunset},SunCalcWrap.prototype.getMoonset=function(a,b,c){var d=this.model.getMoonTimes(a,b,c);return d.set},SunCalcWrap.prototype.getSunPosition=function(a,b,c){var d=this.model.getPosition(a,b,c);return{azimuth:180+rad2deg(d.azimuth),altitude:rad2deg(d.altitude)}},SunCalcWrap.prototype.getMoonPosition=function(a,b,c){var d=this.model.getMoonPosition(a,b,c);return{azimuth:180+rad2deg(d.azimuth),altitude:rad2deg(d.altitude),distance:d.distance}},SunCalcWrap.prototype.getMoonPhase=function(a){var b=this.model.getMoonIllumination(a);return b.phase},SunCalcWrap.prototype.getBestTime=function(a,b,c){a=moment.utc(a);var d=moment.utc(a).add("days",1),e=this.getSunset(a.toDate(),b,c),f=this.getMoonset(a.toDate(),b,c),g=this.getMoonset(d.toDate(),b,c);angular.isDefined(f)||(f=g),moment.utc(e).isSame(moment.utc(f),"days")||(f=g);var h=moment.utc(f).diff(moment.utc(e),"minutes",!0);return-1100>h&&(f=g,h=moment.utc(f).diff(moment.utc(e),"minutes",!0)),{date:moment.utc(e).add("minutes",4/9*h).toDate(),sunset:e,moonset:f,lag:h}};var Criterion=function(a){this.init(a)};Criterion.prototype.init=function(a){this.algorithm=a},Criterion.prototype.getAlgorithm=function(){return this.algorithm},Criterion.prototype.getCode=function(){},Criterion.prototype.calculate=function(){console.log("implement criterion")},Criterion.prototype.calculateAtBestTime=function(a,b,c){return this.date=moment.utc(this.algorithm.getBestTime(a,b,c)),this.calculate(b,c)},Criterion.prototype.calculateAtSunset=function(a,b,c){return this.date=moment.utc(this.algorithm.getSunset(a,b,c)),this.calculate(b,c)},Criterion.prototype.calculateAtSunBelowFiveDegree=function(){console.log("implement criterion")};var Diyanet=function(a){this.init(a)};Diyanet.prototype=new Criterion,Diyanet.prototype.constructor=Diyanet,Diyanet.prototype.getCode=function(a){var b="F";return a.ARCL>8&&a.ALT>5&&(b="A"),b},Diyanet.prototype.calculate=function(a,b,c){var d=this.algorithm.getBestTime(a,b,c);a=d.date;var e=this.algorithm.getSunPosition(a,b,c),f=this.algorithm.getMoonPosition(a,b,c),g=180+rad2deg(e.azimuth),h=rad2deg(e.altitude),i=180+rad2deg(f.azimuth),j=rad2deg(f.altitude),k=Math.abs(g-i),l=Math.abs(j-h),m=0;return m=l>22?Math.acos(Math.cos(k)*Math.cos(l)):Math.sqrt(k*k+l*l),{date:a,sunset:d.sunset,moonset:d.moonset,LAG:d.LAG,code:this.getCode({ARCL:m,ALT:j}),ARCL:m,ALT:j}},Yallop.prototype=new Criterion,Yallop.prototype.constructor=Yallop,Yallop.prototype.calculate=function(a,b,c){var d=this.algorithm.getBestTime(a,b,c);a=d.date;var e=this.algorithm.getSunPosition(a,b,c),f=this.algorithm.getMoonPosition(a,b,c),g=Math.abs(e.azimuth-f.azimuth),h=Math.abs(f.altitude-e.altitude),i=0;i=h>22?Math.acos(Math.cos(g)*Math.cos(h)):Math.sqrt(g*g+h*h);var j=.5*(1-Math.cos(i)),k=11950*j/f.distance,l=(h-(11.8371-6.3226*k+.7319*k*k-.1018*k*k*k))/10,m=this.getCode(l),n={date:a,code:m,sunset:d.sunset,moonset:d.moonset,daz:g,arcv:h,arcl:i,moon_azimuth:f.azimuth,moon_altitude:f.altitude,sun_azimuth:e.azimuth,sun_altitude:e.altitude};return n},Yallop.prototype.getCode=function(a){return a>.216?"A":.216>=a&&a>-.014?"B":-.014>=a&&a>-.16?"C":-.16>=a&&a>-.232?"D":-.232>=a&&a>-.293?"E":-.293>=a?"F":"G"};var CalculatorFactory={create:function(a){return new Calculator(CriterionFactory.create(a))}},createDiyanet=function(a){return new Diyanet(a instanceof Algorithm?new a:new SunCalcWrap)},createYallop=function(a){return new Yallop(a instanceof Algorithm?new a:new SunCalcWrap)},CriterionFactory={create:function(a,b){return"diyanet"===a?createDiyanet(b):createYallop("yallop"===a?b:b)}},rad2deg=function(a){return 180*a/Math.PI},deg2rad=function(a){return a*Math.PI/180};